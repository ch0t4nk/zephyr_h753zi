Updated plan reflecting current progress. Completed items are marked, with CLI examples and recommendations for further improvements.

---

## Plan
- Present a concise, prioritized feature list for the PAN/TILT stepper project.
- For each feature: what it is, success criteria, short implementation notes, and estimated effort.
- Recommend the immediate next implementation and how to proceed.

## Checklist (prioritized)

1. Periodic status poll + human-readable decode (HIGH) — Done
   - What: Decode GET_STATUS bits (faults, busy, thermal, etc.) and present readable text.
   - Success: `stepper status [-v]` shows per-device status; two-phase GET_STATUS implemented for daisy-chain.
   - Notes: Two-phase GET_STATUS implemented; decoder maps bitfields to strings. Kconfig-gated periodic poll worker with ring buffer is implemented and off by default. Shell control added.
   - Est: 1–2 hours.
    - CLI:
       - `stepper status [-v]` — query both devices; add `-v` for verbose decode
       - `stepper probe` — probe both L6470s
       - `stepper poll enable|disable`
       - `stepper poll dump <dev> [n]`
   - Enhancements: Add background poll via k_work/thread (e.g., every 2s) with ring-buffered history, optional JSON logging/telemetry.

2. Interactive shell commands for motoring (HIGH) — Done
   - What: Shell commands to run/move/stop, reset, disable outputs, and power flag.
   - Success: Commands issue RUN/MOVE/SOFTHIZ/HARDHIZ with safety checks.
   - Notes: Handlers call L6470 helpers; argument validation present; MODE3 framing per daisy-chain.
   - Est: 2–4 hours.
   - CLI:
     - `stepper run <dev> <dir:0|1> <speed>`
     - `stepper move <dev> <dir:0|1> <steps>`
     - `stepper disable <dev> [hard]`
     - `stepper reset`
     - `stepper power on|off|status` (software flag only; does not switch VMOT)
   - Recommendations: Add tab-completion and inline help; extend with accel/dec/current and microstep configuration.

3. Motion primitives & parameter wrappers (MED) — Done (encoders + tests complete; wrappers/CLI for ACC/DEC optional)
   - What: Minimal RUN/MOVE/Hi-Z wrappers with correct multi-device framing (4-byte frames/device).
   - Success: Valid packets transmitted; unit tests cover pack/parse helpers.
   - Est: 4–8 hours.
   - CLI: See item 2.
   - Recommendations: ACC/DEC/STAIL/MAX encoders and edge tests are in place; optional: add runtime ACC/DEC/KVAL shell wrappers.

4. Safety and power sequencing (MED) — Done
   - What: RESET pulse support; refuse RUN/MOVE if power disabled or faults latched; enforce limits.
    - Success: Commands are rejected on unsafe conditions; model/Kconfig limits enforced; motion must be explicitly armed; estop halts & disarms.
    - Notes: VMOT is not switched on the shield; `power on` toggles software flag; separate motion arming gate (`stepper arm on|off|status`); estop performs HARDSTOP + HiZ.
   - Est: 1–3 hours.
   - CLI:
     - `stepper power on|off|status`
     - `stepper reset`
       - `stepper arm on|off|status`
       - `stepper estop`
   - Recommendations: If adding hardware VMOT control (FET/relay), extend overlay + driver; surface clear-faults command and warn on active faults.

5. Motor model SSOT (YAML) + codegen + runtime model API (HIGH) — Done
   - What: Single source-of-truth `stepper_models.yml` → Python `gen_stepper_models.py` → autogenerated header consumed by `stepper_models.c`.
   - Success: Models selectable at runtime without firmware rebuild.
   - Notes: Autogen header lives under app build dir; included for both app and unit tests. YAML annotated with datasheet scaling references and verification notes (2025‑09‑04).
   - Est: 4–6 hours.
   - CLI:
     - `stepper model list` — list available models
     - `stepper model show <axis>` — show active model for axis 0/1
     - `stepper model set <axis> <name>` — set active model (persists if backend configured)
   - Recommendations: Extend schema with accel/current/microstep caps; add per-command step limit if desired; validate YAML in CI.

6. Persist active model selection via Zephyr Settings (MED) — Done (validated on-target 2025-09-05)
   - What: Save `stepper/active` (two bytes: indices for axis0/axis1) using settings subsystem.
   - Success: Selection is restored on boot; confirmed on-target. LittleFS mounts with "Mounted existing LittleFS" and settings survive reboot (validated by tools/flash_try.py log and `stepper model show 0`).
   - Notes: Code is guarded by `CONFIG_SETTINGS`. Implemented using `CONFIG_SETTINGS_FILE` with LittleFS mounted at `/lfs` via `persist.c` (early mount + mkfs sentinel). Unit tests stub persistence when FS is not linked. On-target validation completed 2025-09-05; settings file present under `/lfs`.
   - Est: 2–4 hours.
    - Recommendations (nucleo_h753zi `prj.conf`):
       - Current: `CONFIG_SETTINGS_FILE=y` + LittleFS (FMP) at `/lfs`, with `CONFIG_FILE_SYSTEM_MKFS=y` and early mount in `persist.c`.
       - On-target smoke after flashing:
          - `stepper model set 0 17HS3001-20B` then reboot; verify with `stepper model show 0` persists; check `/lfs/settings/run` exists.

7. Native host development without VMOT (native_sim) + unit tests (MED) — Done
   - What: Logic-first development using `native_sim`; compile app sources into ztests; add SPI mock/test hooks.
   - Success: Unit suites pass on host; RUN/MOVE tested via fake SPI; model enforcement validated.
   - Est: 3–6 hours.
   - CLI:
     - Build tests: `west build -b native_sim apps/stm32h753zi_stepper/tests/unit -d build/native_unit --pristine`
     - Run tests: `./build/native_unit/zephyr/zephyr.exe`
   - Recommendations: Strict frame tests added for RUN/MOVE packers; SPI strict mock validates buffer length and opcodes. Next: add fault-path tests for GET_STATUS parsing (e.g., refuse RUN/MOVE when OCD/STEP_LOSS set).

8. Dual-control wiring alternative: per-device CS (OPTIONAL) — REMOVED
   - Removed from active plan; daisy-chain confirmed sufficient. Reintroduce only if hardware rework occurs.

9. Motion coordination / trajectories (LOW → MED) — Pending
   - What: Coordinated pan+tilt moves with accel profiles and trajectory planner.
   - Success: Smooth synchronized moves to absolute positions.
   - Est: 1–3 days.
   - Recommendations: Start with trapezoidal profile + timebase; later jerk-limited S-curve.

10. Logging / telemetry & VCP/Ethernet integration (MED) — Pending
   - What: Periodic JSON status over USB VCP or UDP.
   - Success: Remote host receives structured telemetry; useful for UI/monitoring.
   - Est: 4–8 hours.
   - Recommendations: Use CBOR/zcbor for compactness if bandwidth-limited.

11. CI (LOW) — Pending
   - What: CI to build native_sim unit tests and MCU firmware (pristine), and run ztests.
   - Success: CI green on PRs; autogen verified.
   - Est: 2–6 hours.
   - Recommendations: Cache Zephyr modules; validate YAML → autogen diff; artifact upload of unit test logs.

12. Motion arming & estop gating (MED) — Done (2025-09-06)
   - What: Separate operator-controlled motion enable plus emergency stop.
   - Success: RUN/MOVE rejected with -EACCES when disarmed; estop halts motion and disarms.
   - Notes: Complements power gating; enables safe parameter tuning with power on.
   - CLI: `stepper arm on|off|status`, `stepper estop`.

13. Fault-path test infrastructure (MED) — Done (2025-09-06)
   - What: Deterministic forced status injection + global per-test fixture to reset state.
   - Success: Tests can simulate faults (OCD/STEP_LOSS) and assert run/move rejection deterministically.
   - Notes: Eliminates state bleed between tests; foundation for future fault suites.

14. OCD threshold tuning (MED) — Done (2025-09-06)
   - What: Helper encode/decode functions + shell `ocd get|set <mA>` with persistence of requested mA per axis.
   - Success: Setting persists via settings backend and survives reboot; helper ensures consistent rounding/clamp.
   - Notes: Stores user-requested mA, not just 4-bit code, for accurate round-trip display.
   - CLI: `stepper ocd get`, `stepper ocd set 1500`.

15. Deflake model enforcement test (LOW) — Done (2025-09-06)
   - What: Stabilize intermittent early fault (-EFAULT) in model switching test.
   - Success: Forced clean statuses before success attempt; broadened accepted result set pending deeper root cause analysis.

16. Auto-apply persisted OCD thresholds at boot (MED) — In progress
   - What: On settings load, override model default OCD thresholds prior to first parameter apply.
   - Success (target): After reboot, `stepper ocd get` shows previously set values without manual reapply.
   - Notes: Persistence already stores requested values; wiring to model application pending.

17. Persisted OCD reload unit test (LOW) — Pending
   - What: Simulate settings load path and assert applied OCD register code matches expectation.
   - Success: Test passes under native_sim with mocked settings data.

18. Advanced movement commands (MED) — Pending
   - What: Jog / wait-for-position commands; simple trapezoidal planner.
   - Success: `stepper jog <dev> <dir> <speed>` and `stepper waitpos <dev> <abs_pos>` functional; planner respects max accel/max speed.

19. Hardware validation smoke suite (MED) — Pending
   - What: Automated on-target script verifying power enable, model apply, OCD threshold persistence, basic motion.
   - Success: Script returns zero; logs stored for CI artifact.

20. Root cause analysis for sporadic early fault (LOW) — Pending
   - What: Identify origin of intermittent -EFAULT during run attempts (timing vs. forced statuses vs. uninitialized state).
   - Success: Deterministic reproduction & fix; test tightened to require r == 0.

---

## Daisy-chain mode reminders
- Current: Both L6470s daisy-chained on SPI1 with single CS (D10/PD14).
- All SPI transactions send frames for both devices (command or NOP per device per transfer).
- No hardware changes required; document this choice for maintainers.

---

## How to build/flash firmware (nucleo_h753zi)
- Build: `west build -b nucleo_h753zi apps/stm32h753zi_stepper -d build/h753zi -p always`
- Flash (OpenOCD): `west flash --skip-rebuild --build-dir build/h753zi --runner openocd`
- If OpenOCD fails to connect, try ST-LINK runner: `west flash --skip-rebuild --build-dir build/h753zi --runner stlink`
- Lower SWD speed with OpenOCD via extra args: `west flash --skip-rebuild -d build/h753zi -r openocd -- -c 'adapter speed 400'`

Optional: tasks are available in VS Code for build/flash.

---

## Immediate recommended next steps
Status: Flashing unblocked (OpenOCD with slower SWD succeeded; image programmed ~318 KiB). Persistence validated on-target (2025-09-05).

1) Hardware validation (with real motors): create a smoke checklist (power, `status -v`, `run/move`, stop, persistence re-check). Capture logs and any anomalies.
2) Motion: add ACC/DEC shell wrappers and implement a simple trapezoidal planner; CLI: `stepper accel`, `stepper decel`, `stepper goto <deg>` (maps to steps via model).
3) Tests: add a fault-path ztest that refuses RUN/MOVE when GET_STATUS indicates OCD/STEP_LOSS; extend strict mock if needed to validate full frame contents.

---

If you want, I can implement (1) NVS settings on-target now, or (2) add stricter SPI frame validation tests next.