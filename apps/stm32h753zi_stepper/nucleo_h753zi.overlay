// Device tree overlay for STM32H753ZI stepper application
// The board default configuration already uses USART3 (PD8/PD9) for console
// which is connected to ST-LINK VCP, so no changes needed

/ {
    // No changes needed - using board defaults
};

/* Inline X-NUCLEO-IHM02A1 wiring for SPI1 and control GPIOs */
&arduino_spi {
    status = "okay";
    spidev: spi-device@0 {
        compatible = "zephyr,spidev";
        reg = <0>;
        spi-max-frequency = <20000000>;
        cs-gpios = <&gpiod 14 GPIO_ACTIVE_LOW>;
        status = "okay";
    };
};

/ {
    ihm02a1_cs: ihm02a1-cs {
        gpios = <&gpiod 14 GPIO_ACTIVE_LOW>; /* D10: PD14 */
        status = "okay";
    };
    ihm02a1_flag: ihm02a1-flag {
        gpios = <&gpiog 14 GPIO_ACTIVE_LOW>;  /* D2: PG14 */
        status = "okay";
    };
    ihm02a1_busy: ihm02a1-busy {
        gpios = <&gpioe 13 GPIO_ACTIVE_HIGH>; /* D3: PE13 */
        status = "okay";
    };
    ihm02a1_reset: ihm02a1-reset {
        gpios = <&gpioe 14 GPIO_ACTIVE_LOW>; /* D4: PE14 */
        status = "okay";
    };
};

/*
 * Define an application-specific storage partition placed high in flash.
 * Rationale:
 * - The board's default "storage" partition sits at 0x00020000 (128KB),
 *   which overlaps with our application image when booting from 0x08000000.
 * - LittleFS also requires at least two erase blocks; STM32H7 erase block
 *   is 128KB, so we allocate 256KB (2 blocks) for the FS.
 * - This keeps persistence safe from firmware writes.
 */
&flash0 {
    partitions {
        /* Place app_storage within Bank 0 at 512KB offset
         * to ensure compatibility (Bank 1 may have access restrictions) */
        app_storage: partition@80000 {
            label = "app-storage";
            reg = <0x00080000 0x00080000>; /* 512KB at 0x0008_0000 */
        };
    };
};